<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Opencart Custom Fields</name>
    <code>custom_fields</code>
    <version>1.0</version>
    <author>d1sc0nnect0r</author>
    <link>http://finesites.ru/</link>
	<!-- Category -->
    <file path="admin/controller/catalog/category.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('catalog/category_form', $data));]]></search>
            <add position="before"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				if (isset($this->error['custom_fields'])) {
					$data['error_custom_fields'] = $this->error['custom_fields'];
				} else {
					$data['error_custom_fields'] = array();
				}
				
				$this->load->model('extension/module/custom_fields');
				
				if (isset($this->request->post['custom_field'])) {
					$data['custom_field'] = $this->request->post['custom_field'];
				} elseif (!empty($category_info)) {
					$data['custom_field'] = $this->model_extension_module_custom_fields->getCustomFieldsByEntity('category', $category_info['category_id']);
				} else {
					$data['custom_field'] = array();
				}
			}
			
			///
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[function validateForm()]]></search>
            <add position="after"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				$this->load->model('extension/module/custom_fields');
				$filter_data = array(
					'filter_entity'	=> 'category',
					'sort'  => 'c.sort_order',
					'order' => 'ASC',
					'start' => 0,
					'limit' => 1000
				);
				
				$this->load->model('localisation/language');
				$languages = $this->model_localisation_language->getLanguages();
				
				$results = $this->model_extension_module_custom_fields->getCustomFields($filter_data);
				
				require_once(DIR_SYSTEM . 'library/custom_fields.php');
				
				foreach($results as $result){
					if($result['required']){
						if(file_exists(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php')){
							require_once(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php');
							$class='CustomFields'.$result['type'];
							$cl = new $class();
							
							if(!isset($this->request->post['custom_field'][$result['custom_fields_id']])){
								$this->request->post['custom_field'][$result['custom_fields_id']] = array();
								foreach($languages as $language){
									$this->request->post['custom_field'][$result['custom_fields_id']][$language['language_id']]=array();
								}
							}
							
							
								foreach ($this->request->post['custom_field'][$result['custom_fields_id']] as $language_id => $value) {
									if(!$cl->validate($value)){
										$this->error['custom_fields'][$result['custom_fields_id']][$language_id] = $result['texterror'];
									}
								}
							
						}
					}
				}
			}
			//
			]]></add>
        </operation>
    </file>
	<file path="admin/model/catalog/category.php">
        <operation>
            <search><![CDATA[foreach ($data['category_description'] as $language_id => $value)]]></search>
            <add position="before"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity='category_id=" . (int)$category_id . "'");
			foreach ($data['custom_field'] as $key=>$val) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "custom_fields SET custom_fields_id = '" . (int)$key . "', entity='category_id=" . (int)$category_id . "', data='".$this->db->escape(serialize($val))."'");
			}
			//
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "category WHERE category_id = '" . (int)$category_id . "'");]]></search>
            <add position="after"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity = 'category_id=" . (int)$category_id . "'");
			//
			]]></add>
        </operation>
    </file>
	<!-- Manufacturer -->
    <file path="admin/controller/catalog/manufacturer.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('catalog/manufacturer_form', $data));]]></search>
            <add position="before"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				if (isset($this->error['custom_fields'])) {
					$data['error_custom_fields'] = $this->error['custom_fields'];
				} else {
					$data['error_custom_fields'] = array();
				}
				
				$this->load->model('extension/module/custom_fields');
				
				if (isset($this->request->post['custom_field'])) {
					$data['custom_field'] = $this->request->post['custom_field'];
				} elseif (!empty($manufacturer_info)) {
					$data['custom_field'] = $this->model_extension_module_custom_fields->getCustomFieldsByEntity('manufacturer', $manufacturer_info['manufacturer_id']);
				} else {
					$data['custom_field'] = array();
				}
			}
			
			///
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[function validateForm()]]></search>
            <add position="after"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				$this->load->model('extension/module/custom_fields');
				$filter_data = array(
					'filter_entity'	=> 'manufacturer',
					'sort'  => 'c.sort_order',
					'order' => 'ASC',
					'start' => 0,
					'limit' => 1000
				);
				
				$this->load->model('localisation/language');
				$languages = $this->model_localisation_language->getLanguages();
				
				$results = $this->model_extension_module_custom_fields->getCustomFields($filter_data);
				
				require_once(DIR_SYSTEM . 'library/custom_fields.php');
				
				foreach($results as $result){
					if($result['required']){
						if(file_exists(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php')){
							require_once(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php');
							$class='CustomFields'.$result['type'];
							$cl = new $class();
							
							if(!isset($this->request->post['custom_field'][$result['custom_fields_id']])){
								$this->request->post['custom_field'][$result['custom_fields_id']] = array();
								foreach($languages as $language){
									$this->request->post['custom_field'][$result['custom_fields_id']][$language['language_id']]=array();
								}
							}
							
							
								foreach ($this->request->post['custom_field'][$result['custom_fields_id']] as $language_id => $value) {
									if(!$cl->validate($value)){
										$this->error['custom_fields'][$result['custom_fields_id']][$language_id] = $result['texterror'];
									}
								}
							
						}
					}
				}
			}
			//
			]]></add>
        </operation>
    </file>
	<file path="admin/model/catalog/manufacturer.php">
        <operation>
            <search><![CDATA[foreach ($data['manufacturer_description'] as $language_id => $value)]]></search>
            <add position="before"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity='manufacturer_id=" . (int)$manufacturer_id . "'");
			foreach ($data['custom_field'] as $key=>$val) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "custom_fields SET custom_fields_id = '" . (int)$key . "', entity='manufacturer_id=" . (int)$manufacturer_id . "', data='".$this->db->escape(serialize($val))."'");
			}
			//
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "manufacturer WHERE manufacturer_id = '" . (int)$manufacturer_id . "'");]]></search>
            <add position="after"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity = 'manufacturer_id=" . (int)$manufacturer_id . "'");
			//
			]]></add>
        </operation>
    </file>
	<!-- Product -->
    <file path="admin/controller/catalog/product.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('catalog/product_form', $data));]]></search>
            <add position="before"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				if (isset($this->error['custom_fields'])) {
					$data['error_custom_fields'] = $this->error['custom_fields'];
				} else {
					$data['error_custom_fields'] = array();
				}
				
				$this->load->model('extension/module/custom_fields');
				
				if (isset($this->request->post['custom_field'])) {
					$data['custom_field'] = $this->request->post['custom_field'];
				} elseif (!empty($product_info)) {
					$data['custom_field'] = $this->model_extension_module_custom_fields->getCustomFieldsByEntity('product', $product_info['product_id']);
				} else {
					$data['custom_field'] = array();
				}
			}
			
			///
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[function validateForm()]]></search>
            <add position="after"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				$this->load->model('extension/module/custom_fields');
				$filter_data = array(
					'filter_entity'	=> 'product',
					'sort'  => 'c.sort_order',
					'order' => 'ASC',
					'start' => 0,
					'limit' => 1000
				);
				
				$this->load->model('localisation/language');
				$languages = $this->model_localisation_language->getLanguages();
				
				$results = $this->model_extension_module_custom_fields->getCustomFields($filter_data);
				
				require_once(DIR_SYSTEM . 'library/custom_fields.php');
				
				foreach($results as $result){
					if($result['required']){
						if(file_exists(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php')){
							require_once(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php');
							$class='CustomFields'.$result['type'];
							$cl = new $class();
							
							if(!isset($this->request->post['custom_field'][$result['custom_fields_id']])){
								$this->request->post['custom_field'][$result['custom_fields_id']] = array();
								foreach($languages as $language){
									$this->request->post['custom_field'][$result['custom_fields_id']][$language['language_id']]=array();
								}
							}
							
							
								foreach ($this->request->post['custom_field'][$result['custom_fields_id']] as $language_id => $value) {
									if(!$cl->validate($value)){
										$this->error['custom_fields'][$result['custom_fields_id']][$language_id] = $result['texterror'];
									}
								}
							
						}
					}
				}
			}
			//
			]]></add>
        </operation>
    </file>
	<file path="admin/model/catalog/product.php">
        <operation>
            <search><![CDATA[foreach ($data['product_description'] as $language_id => $value)]]></search>
            <add position="before"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity='product_id=" . (int)$product_id . "'");
			foreach ($data['custom_field'] as $key=>$val) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "custom_fields SET custom_fields_id = '" . (int)$key . "', entity='product_id=" . (int)$product_id . "', data='".$this->db->escape(serialize($val))."'");
			}
			//
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "product WHERE product_id = '" . (int)$product_id . "'");]]></search>
            <add position="after"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity = 'product_id=" . (int)$product_id . "'");
			//
			]]></add>
        </operation>
    </file>
	<!-- Information -->
    <file path="admin/controller/catalog/information.php">
        <operation>
            <search><![CDATA[$this->response->setOutput($this->load->view('catalog/information_form', $data));]]></search>
            <add position="before"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				if (isset($this->error['custom_fields'])) {
					$data['error_custom_fields'] = $this->error['custom_fields'];
				} else {
					$data['error_custom_fields'] = array();
				}
				
				$this->load->model('extension/module/custom_fields');
				
				if (isset($this->request->post['custom_field'])) {
					$data['custom_field'] = $this->request->post['custom_field'];
				} elseif (!empty($information_info)) {
					$data['custom_field'] = $this->model_extension_module_custom_fields->getCustomFieldsByEntity('information', $information_info['information_id']);
				} else {
					$data['custom_field'] = array();
				}
			}
			
			///
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[function validateForm()]]></search>
            <add position="after"><![CDATA[
            //custom_fields
			if($this->config->get('module_custom_fields_status')){
				$this->load->model('extension/module/custom_fields');
				$filter_data = array(
					'filter_entity'	=> 'information',
					'sort'  => 'c.sort_order',
					'order' => 'ASC',
					'start' => 0,
					'limit' => 1000
				);
				
				$this->load->model('localisation/language');
				$languages = $this->model_localisation_language->getLanguages();
				
				$results = $this->model_extension_module_custom_fields->getCustomFields($filter_data);
				
				require_once(DIR_SYSTEM . 'library/custom_fields.php');
				
				foreach($results as $result){
					if($result['required']){
						if(file_exists(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php')){
							require_once(DIR_SYSTEM . 'library/custom_fields/'.$result['type'].'/index.php');
							$class='CustomFields'.$result['type'];
							$cl = new $class();
							
							if(!isset($this->request->post['custom_field'][$result['custom_fields_id']])){
								$this->request->post['custom_field'][$result['custom_fields_id']] = array();
								foreach($languages as $language){
									$this->request->post['custom_field'][$result['custom_fields_id']][$language['language_id']]=array();
								}
							}
							
							
								foreach ($this->request->post['custom_field'][$result['custom_fields_id']] as $language_id => $value) {
									if(!$cl->validate($value)){
										$this->error['custom_fields'][$result['custom_fields_id']][$language_id] = $result['texterror'];
									}
								}
							
						}
					}
				}
			}
			//
			]]></add>
        </operation>
    </file>
	<file path="admin/model/catalog/information.php">
        <operation>
            <search><![CDATA[foreach ($data['information_description'] as $language_id => $value)]]></search>
            <add position="before"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity='information_id=" . (int)$information_id . "'");
			foreach ($data['custom_field'] as $key=>$val) {
				$this->db->query("INSERT INTO " . DB_PREFIX . "custom_fields SET custom_fields_id = '" . (int)$key . "', entity='information_id=" . (int)$information_id . "', data='".$this->db->escape(serialize($val))."'");
			}
			//
			]]></add>
        </operation>
		<operation>
            <search><![CDATA[$this->db->query("DELETE FROM " . DB_PREFIX . "information WHERE information_id = '" . (int)$information_id . "'");]]></search>
            <add position="after"><![CDATA[
			//custom_fields
			$this->db->query("DELETE FROM " . DB_PREFIX . "custom_fields WHERE entity = 'information_id=" . (int)$information_id . "'");
			//
			]]></add>
        </operation>
    </file>
</modification>